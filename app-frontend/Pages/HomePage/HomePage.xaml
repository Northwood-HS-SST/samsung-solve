<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:homePage="clr-namespace:app_frontend.Pages.HomePage"
             xmlns:converters="clr-namespace:app_frontend.Converters"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             x:Class="app_frontend.Pages.HomePage.HomePage"
             x:DataType="homePage:HomePageViewModel"
             Title="Home Page">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringToVisibilityConverter x:Key="StringToVisibility" />
        </ResourceDictionary>
    </ContentPage.Resources>



    <Grid RowSpacing="10" >
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <CollectionView 
            ItemsSource="{Binding AvailablePopups}"
            SelectionMode="None"
            Margin="20,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="homePage:HomePageViewModel+Popup">
                    <Border
                        BackgroundColor="#4b8e8b"
                        StrokeThickness="0"
                        Padding="10"
                        VerticalOptions="Center">
                        <Border.StrokeShape>
                            <RoundRectangle CornerRadius="10" />
                        </Border.StrokeShape>

                        <VerticalStackLayout>
                            <Grid ColumnDefinitions="*, Auto">
                                <Label 
                                    Grid.Column="0"
                                    Text="{Binding Title}"
                                    TextColor="White"
                                    FontSize="24"
                                    FontAttributes="Bold"
                                    HorizontalOptions="Start"
                                    VerticalOptions="CenterAndExpand" />
                                <ImageButton  Grid.Column="1"
                                              Source="{mi:MaterialRounded Close}"
                                              BackgroundColor="Transparent"
                                              WidthRequest="10"
                                              HeightRequest="10"
                                              Command="{Binding Source={RelativeSource AncestorType={x:Type homePage:HomePageViewModel}}, Path=ClosePopupCommand}"
                                              CommandParameter="{Binding .}"
                                >
                                </ImageButton>
                            </Grid>
                            <Label
                                Text="{Binding Content}"
                                TextColor="White"
                                FontSize="16"
                                HorizontalOptions="Start"
                                VerticalOptions="CenterAndExpand" />
                        </VerticalStackLayout>



                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>


        <RefreshView Grid.Row="1" IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}">
            <CollectionView 
                        ItemsSource="{Binding AvailableEntries}"
                        SelectionMode="None"
                        Margin="20,0">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="homePage:HomePageViewModel+SearchResult">
                        <Frame Padding="0" 
                               Margin="0,0,0,15" 
                               CornerRadius="10" 
                               HasShadow="True"
                               BorderColor="LightGray">
                            <Grid Padding="15">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <!-- Header: Profile Photo, Name, Time -->
                                <Grid Grid.Row="0" ColumnSpacing="10" Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="50" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Profile Photo -->
                                    <Frame Grid.Column="0" 
                                           WidthRequest="50" 
                                           HeightRequest="50" 
                                           CornerRadius="25" 
                                           Padding="0" 
                                           IsClippedToBounds="True"
                                           HasShadow="False"
                                           BorderColor="LightGray">
                                        <Image Source="{Binding ProfilePhotoUrl}" 
                                               Aspect="AspectFill" />
                                    </Frame>

                                    <!-- Name and Time -->
                                    <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                        <Label Text="{Binding UserName}" 
                                               FontSize="16" 
                                               FontAttributes="Bold" />
                                        <Label Text="{Binding TimePosted}" 
                                               FontSize="12" 
                                               TextColor="Gray" />
                                    </VerticalStackLayout>

                                    <!-- Message Button -->
                                    <Button
                                        Grid.Column="2"
                                        x:Name="ContinueButton"
                                        Text = "Message"
                                        FontSize="16"
                                        FontFamily = "KohSantepheapRegular"
                                        TextColor="White"
                                        BackgroundColor="#3F7875"
                                        HorizontalOptions="Center"
                                        CornerRadius="10"
                                        HeightRequest="0"/>

                                    <mi:MauiIcon Grid.Column="3"  Icon="{mi:MaterialRounded LocalFireDepartment}" IconColor="OrangeRed" IconSize="30" IsVisible="{Binding HasSpecialOutline}" />

                                </Grid>

                                <!-- Post Content/Text -->
                                <Label Grid.Row="1" 
                                       Text="{Binding Content}" 
                                       FontSize="14" 
                                       Margin="0,0,0,10"
                                       LineBreakMode="WordWrap" />

                                <!-- Post Image (Hidden if no ImageUrl) -->
                                <Border Grid.Row="2" 
                                        StrokeShape="RoundRectangle 8"
                                        Margin="0,0,0,10"
                                        IsVisible="{Binding ImageUrl, Converter={StaticResource StringToVisibility}}">
                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" 
                                                     Binding="{Binding HasSpecialOutline}" 
                                                     Value="True">
                                            <Setter Property="Stroke" Value="OrangeRed" />
                                            <Setter Property="StrokeThickness" Value="3" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Border" 
                                                     Binding="{Binding HasSpecialOutline}" 
                                                     Value="False">
                                            <Setter Property="Stroke" Value="Transparent" />
                                            <Setter Property="StrokeThickness" Value="0" />
                                        </DataTrigger>
                                    </Border.Triggers>
                                    <Image Source="{Binding ImageUrl}" 
                                           Aspect="AspectFill" 
                                           HeightRequest="300" />
                                </Border>

                                <!-- Interaction Buttons -->
                                <Grid Grid.Row="3" ColumnSpacing="20">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Like Button -->
                                    <Button Grid.Column="0" 
                                            Text="â¤ï¸ Like" 
                                            FontSize="14"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type homePage:HomePageViewModel}}, Path=LikeCommand}"
                                            CommandParameter="{Binding .}" />

                                    <!-- Comment Button -->
                                    <Button Grid.Column="1" 
                                            Text="ðŸ’¬ Comment" 
                                            FontSize="14"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type homePage:HomePageViewModel}}, Path=CommentCommand}"
                                            CommandParameter="{Binding .}" />

                                    <!-- Share Button -->
                                    <Button Grid.Column="2" 
                                            Text="ðŸ”— Share" 
                                            FontSize="14"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type homePage:HomePageViewModel}}, Path=ShareCommand}"
                                            CommandParameter="{Binding .}" />

                                    <!-- Save Button -->
                                    <Button Grid.Column="3" 
                                            Text="ðŸ”– Save" 
                                            FontSize="14"
                                            BackgroundColor="Transparent"
                                            TextColor="{AppThemeBinding Light=Black, Dark=White}"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type homePage:HomePageViewModel}}, Path=SaveCommand}"
                                            CommandParameter="{Binding .}" />
                                </Grid>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="0" />
                </CollectionView.ItemsLayout>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>